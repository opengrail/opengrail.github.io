<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Datomic On Heroku!</title>
  <meta name="description" content="Datomic On Heroku">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.opengrail.com/jekyll/update/2015/11/19/datomic-heroku-spaces.html">
  <link rel="alternate" type="application/rss+xml" title="Opengrail blog" href="http://blog.opengrail.com/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Opengrail blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Datomic On Heroku!</h1>
    <p class="post-meta"><time datetime="2015-11-19T19:59:38+01:00" itemprop="datePublished">Nov 19, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><strong>Datomic On Heroku</strong></p>

<p><strong>Datomic</strong> is an immutable, append-only databases that stores all of your new and historic data. It’s easy to keep a history of prices or customers or whatever but not just as individual entities but as part of the history of the entire database. It comes from Rich Hickey and the other guys at Cognitect that brought you Clojure. It retains the ACID properties of the traditional RDBMS and has revived a logic programming interface to make queries using Datalog.  The other interesting aspect of Datomic is that it can offload the job of permanent storage to another database - like Postgres or Riak. There’s a ton more innovation from Datomic so check out the videos and other introductory material on <a href="https://www.datomic.com">the Datomic website</a></p>

<p><strong>Heroku</strong> is a well known Platform As A Service (PAAS) which is rightly famed for its simplicity and its ease of use.  It has some strong opinions about how to make applications scalable using a stateless application model and has long supported the now hotness that is Linux containers. It has also made using Postgres incredibly easy with tools to fork and clone databases in seconds. Whilst Heroku started with Ruby, it can now run Java, node.js and even Clojure apps. To get started with Heroku go and download the <a href="https://toolbelt.heroku.com">Heroku Toolbelt</a> so you can have a CLI.</p>

<p><strong>BFFs FTW?</strong></p>

<p>I like Datomic and Heroku on their own merits. A year or so ago when I first started getting into Datomic I thought they could be friends. Two interesting, powerful and yet simple technologies with a lot in common: a focus on simplicity, friendly to Clojure and more than a passing interest in Postgres. Surely they would hit it off. But no, there was trouble in paradise: Datomic assumes that it is configured behind a secure network while Heroku assumes that you want everything out in the open. It was like taking a nun to a nude beach.</p>

<p><strong>Leveraging strategic synergies in skinny jeans</strong></p>

<p>Well that was awkward. But it seems like the naturalists are putting on some clothes. Whilst Heroku rose to fame with the high profile start-ups that used its service (Uber and Automatic as a few examples), it is turning its attention to capturing the hearts and minds of larger, more established enterprises. It hasn’t quite put on a three-piece suit and tie but a pair of skinny jeans and a conference tee shirt is already making it seem more attractive to the nuns.</p>

<p><strong>Spaced out</strong></p>

<p>Ok listen, forget the nuns, let’s get back to what Heroku are doing to appeal to more traditional businesses: a service called Spaces which is Virtual Private Cloud (VPC), done in a way that seems true to the spirit of the Heroku platform - simple and easy to use. You can deploy web apps and worker processes as easily as before but they can now be hidden behind the curtain provided by the VPC. This makes a better match for Datomic, which just to clear it up, is also not really a nun.</p>

<p>I have been fortunate to have access to the private Beta version of Spaces for work reasons and it meant that I could try out my idea again on the side. Maybe the introductions would be more cordial this time around. And of course it was, so let’s get into the details…</p>

<p><strong>Pack, Hack and Stack</strong></p>

<p>Heroku apps are deployed using a buildpack, which is the script needed to install and run up any service on the platform. There are some official build packs for Ruby, Java, node.js, etc… but you can can extend them or make your own and people do. So I did. Datomic has a dependency on Java so it made sense to use the Heroku official Java buildpack as a starting point for the hacking.</p>

<p><strong>Starting, a fight</strong></p>

<p>Datomic itself comes in a few flavours: Free, Pro and Pro+. The Free version is obviously the most accessible so I wanted to support that one and indeed it is the default. Free is great for playtime but only stores the data in memory or a disk that is local to the app. It is not a great fit for Heroku: Did I say Heroku is built on stateless principles? The disks are also ephemeral. So with the free version everything is wiped when you restart your app. All to say that it’s OK to kick the tyres but it doesn’t really take advantage of the Heroku platform very well and one could even say that the Heroku platform is slightly hostile. If deleting all of the database’s data could be described as hostile.</p>

<p><strong>ZOMG BFFs FTW fr raal</strong></p>

<p>So for the Datomic Free version story is not so great. But Datomic has another free to access version called the Pro Starter Pack. This allows up two web apps (also called Peers) to connect to the database and any one of the backend database storage engines can be brought into play.  With Datomic Starter Pack plus Heroku Postgres, we really do have game on.</p>

<p><strong>Datomic Starter Pack</strong> [Ceremony alert]</p>

<p>There is a little bit of ceremony (registration and email) to obtain a license for the Datomic Starter Pack so I’ll let you do that … we’ll still be here when you come back.</p>

<p>OK, so you’re back and armed with your license you are now only a few seconds from deploying your first app.</p>

<p><strong>Heroku Spaces</strong> [Ceremony alert]</p>

<p>OK, I was fibbing.  There is also a little ceremony on Heroku as you will need to have an Enterprise account - contact the Heroku account manager to organise that.</p>

<p>OK, so you’re back again. Phew! Let’s get started…</p>

<p><strong>Create your transactor app</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku apps:create my-xtor -s my-space</code></pre></figure>

<p><strong>Configure the Datomic buildpack</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku buildpacks:set https://github.com/opengrail/heroku-buildpack-datomic -a my-xtor</code></pre></figure>

<p><strong>Provision your database</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku addons:create heroku-postgresql</code></pre></figure>

<p>The Postgres addon will be configured at the lowest cost - free - option, which is limited to 10k rows.</p>

<p><strong>Clone the demo transactor app</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/raymcdermott/space-xtor</code></pre></figure>

<p><strong>Configure your Datomic license for Heroku</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku config:set <span class="nv">DATOMIC_LICENSE_PASSWORD</span><span class="o">=</span>license-password
heroku config:set <span class="nv">DATOMIC_LICENSE_USER</span><span class="o">=</span>license-user
heroku config:set <span class="nv">DATOMIC_TRANSACTOR_KEY</span><span class="o">=</span>license-key</code></pre></figure>

<p><strong>Push the app</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git push heroku master</code></pre></figure>

<p><strong>Create your web app</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku apps:create my-xtor-web-front -s my-space</code></pre></figure>

<p><strong>Attach your database</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>heroku addons -a my-xtor

Add-on                                           Plan       Price
───────────────────────────────────────────────  ─────────  ─────
heroku-postgresql <span class="o">(</span>postgresql-xyzabc-1234<span class="o">)</span>       hobby-dev  free 
 └─ as DATABASE                                                  

The table above shows add-ons and the attachments to the current app <span class="o">(</span>space-xtor<span class="o">)</span> or other apps.

heroku addons:attach postgresql-xyzabc-1234 -a my-xtor-web-front</code></pre></figure>

<p><strong>Clone the demo web app</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/raymcdermott/xtor-web-front</code></pre></figure>

<p><strong>Push the demo web app</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git push heroku master</code></pre></figure>

<p><strong>Test it all out</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku open -a my-xtor-web-front</code></pre></figure>

<p><strong>Operating costs</strong></p>

<p>All of the Datomic software and Heroku Postgres services are free. Be careful to watch your dyno use on Heroku as it’s possible to go beyond the free tier if you play for too long.</p>

<p>Obviously you can spend as much as you want with Datomic or Heroku once you get going.</p>

<p>The code is on github so you can try it out for yourself and let me know how it works out.</p>

<p>I would appreciate a link or a tweet if you found this useful.</p>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Opengrail blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Opengrail blog</li>
          <li><a href="mailto:blog@opengrail.com">blog@opengrail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/raymcdermott"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">raymcdermott</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/raymcdermott"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">raymcdermott</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Thoughts on Clojure, Datomic and related technology
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
